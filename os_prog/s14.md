# Thread

## 1. 线程(thread)

是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务

### 线程的概念

线程的概念
由于同一进程的多个线程共享同一地址空间，因此Text Segment、Data Segment都是共享的，如果定义一个函数，在各线程中都可以调用，如果定义一个全局变量，在各线程中都可以访问到，除此之外，各线程还共享以下进程资源和环境：

* #地址空间
  * .rodata(readonly data段,ELF严格来说不属于data段，在全局区域中
![segment](https://raw.githubusercontent.com/youhuangla/images/main/202202091700875.png)
  * 堆空间
  malloc返回的值可在函数间传递
* 1. 文件描述符表
* 2. 种信号的处理方式
* 3. 当前工作目录
* 4. 用户id和组id

但有些资源是每个线程各有一份的：

* 1. 线程id
* 2. 上下文，包括各种寄存器的值、程序计数器和栈指针
* 3. 栈空间
* 4. errno变量
* 5. 信号屏蔽字
* 6. 调度优先级

在Linux上线程函数位于libpthread共享库中，因此在编译时要加上-plthread

## 线程控制

### 创建线程

```c
#include<pthread.h>

int pthread_create (pthread_t *restrict thread, \
/*pthread_t类似pid_t,返回一个“pid”, 结果参数，记录子线程id，有返回值效果。restrict 加强安全性,内存只能通过该指针修改*/ 
const pthread attr_t *restrict attr, \
/*thread属性，课程中使用较少*/ 
void *(*start_routine)(void*), \
/*start_routine函数指针，(void *传啥都可以，可传入结构体等)，子线程入口地址*/
void *restrict arg/*传的参数列表*/);
```

* #a function,回调函数(call back):通过参数将函数传递到其它代码的，某一块可执行代码的引用。这一设计允许了底层代码调用在高层定义的子程序。
<https://zh.wikipedia.org/wiki/%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0>
可用于jsp前台窗口
![call back function](https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Callback-notitle.svg/2560px-Callback-notitle.svg.png)

```c
/**/pcr(tid, NULL, func, argv)

```

返回值：成功返回0，失败返回错误号。以前学过的系统函数都是成功返回0，失败返回-1，而错误号保存在全局变量errno中，而pthread库的函数都是通过返回值返回错误号，虽然每个线程也都有一个errno，但这是为了兼容其它函数接口而提供的，pthread库本身并不使用它，通过返回值返回错误码更加清晰

## 获取当前线程的id

```c
#include <pthread.h> 
pthread_t pthread_self(void);
```

Compile and link with -plthread.

返回值：总是成功返回，返回调用该函数线程ID

* man 3 pthread_create

The new thread inherits a copy of the creating thread's signal mask (pthread_sigmask(3)).  The set  of  pending signals for  the  new  thread  is empty (sigpending(2)).  The new thread does not inherit the creating thread's alternate signal stack (sigaltstack(2)).

* man 3 pthread_self

* createThread.c
  * ld链接器

```bash
youhuangla@Ubuntu s14 % gcc createThread.c                                                                                     [0]
/tmp/ccnKCUYo.o: In function `main':
createThread.c:(.text+0x5d): undefined reference to `pthread_create'
collect2: error: ld returned 1 exit status
youhuangla@Ubuntu s14 % gcc createThread.c -lpthread                                                                           [0]
youhuangla@Ubuntu s14 % ./a.out                                                                                                [0]
maint thread
```
