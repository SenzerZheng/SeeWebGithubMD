# s19 网络层协议硬件


[TOC]



## ICMP与ping：投石问路的侦察兵

- 无论是在宿舍，还是在办公室，或者运维一个数据中心，我们常常会遇到网络不通的问题。那台机器明明就在那里，你甚至都可以通过机器的终端连上去看。它看着好好的，可是就是连不上去，究竟是哪里出了问题呢？

### ICMP 协议的格式

- 一般情况下，你会想到 ping 一下。那你知道 ping 是如何工作的吗？
- ping 是基于 ICMP 协议工作的。ICMP全称Internet Control Message Protocol，就是互联网控制报文协议。这里面的关键词是“控制”，那具体是怎么控制的呢？
- 网络包在异常复杂的网络环境中传输时，常常会遇到各种各样的问题。当遇到问题的时候，总不能“死个不明不白”，要传出消息来，报告情况，这样才可以调整传输策略。这就相当于我们经常看到的电视剧里，古代行军的时候，为将为帅者需要通过侦察兵、哨探或传令兵等人肉的方式来掌握情况，控制整个战局。
- ICMP 报文是封装在 IP 包里面的。因为传输指令的时候，肯定需要源地址和目标地址。它本身非常简单。因为作为侦查兵，要轻装上阵，不能携带大量的包袱。

![](img/202202212121216.png)

<img src="img/202202212127963.png" alt="*TCP/IP Illustrated, Volume 1: The Protocols*. *W. Richard Stevens.*" style="zoom:50%;" />

<center>IPv4的IP数据报格式</center>

- [《Linux C编程一站式学习》](https://akaedu.github.io/book/ch36s04.html)
- IP数据报的首部长度和数据长度都是可变长的，但总是4字节的整数倍。
- 对于IPv4，4位版本字段是4。
- 4位首部长度的数值是以4字节为单位的，最小值为5，也就是说<a name="首部最小长度">首部长度最小</a>是4x5=20字节，也就是不带任何选项的IP首部，4位能表示的最大值是15，也就是说IP数据报首部长度最大是60字节。
- 8位TOS字段有3个位用来指定IP数据报的优先级（目前已经废弃不用），还有4个位表示可选的服务类型（最小延迟、最大呑吐量、最大可靠性、最小成本），还有一个位总是0。
- 总长度是整个数据报（包括IP首部和IP层payload）的字节数。
- 每传一个IP数据报，16位的标识加1，可用于分片和重新组装数据报。
- 3位标志和13位片偏移用于分片。
- TTL（Time to live)是这样用的：源主机为数据包设定一个生存时间，比如64，每过一个路由器就把该值减1，如果减到0就表示路由已经太长了仍然找不到目的主机的网络，就丢弃该包，因此这个生存时间的单位不是秒，而是跳（hop）。
- 协议字段指示上层协议是TCP、UDP、ICMP还是IGMP。
- 然后是校验和，只校验IP首部，数据的校验由更高层协议负责。
- IPv4的IP地址长度为32位。选项字段的解释从略。

#### 抓包

```powershell
PS C:\Users\Administrator> ping www.baidu.com

正在 Ping www.a.shifen.com [183.232.231.172] 具有 32 字节的数据:#百度早期是一个打分网站shifen，183.232.231.172即是百度服务器的IP地址，每个人ping的IP可能不一样，百度有很多服务器
来自 183.232.231.172 的回复: 字节=32 时间=15ms TTL=56
来自 183.232.231.172 的回复: 字节=32 时间=16ms TTL=56
来自 183.232.231.172 的回复: 字节=32 时间=15ms TTL=56
来自 183.232.231.172 的回复: 字节=32 时间=21ms TTL=56

183.232.231.172 的 Ping 统计信息:
    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
往返行程的估计时间(以毫秒为单位):
    最短 = 15ms，最长 = 21ms，平均 = 16ms
```

- ping发送了四次请求，收到了服务器的四次回复

![](img/202202212059567.png)

- 开头是目的和源MAC地址各占6字节
- 0100 .... = Version: 4#对于IPv4，四位版本号字段是4

![](img/202202212316825.png)

- .... 0101 = Header Length: 20 bytes (5)#表示首部长度为5 * 4 = 20字节（[首部最小长度](#首部最小长度)）

![](img/202202212108996.png)

<center>IPv4首部,长度为20字节</center>

![](img/202202212107504.png)

- Differentiated Services Field: 0x00#8位TOS字段
- Total Length:60，图中可算得上下选中部分十六进制总共60字节，表示整个数据报（包括IP首部和IP层payload）的字节数

![](img/202202212112310.png)

<center>IP报文总长度验证</center>

![](img/202202212339955.png)

<center>ICMP协议，长度为40字节</center>

